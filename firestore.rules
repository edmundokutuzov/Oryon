/**
 * @fileoverview Firestore Security Rules for Oryon Insurance Platform
 *
 * Core Philosophy:
 * This ruleset implements Role-Based Access Control (RBAC) to secure data access.
 * Users are assigned roles (e.g., 'admin', 'contentManager', 'riskAnalyst') that dictate their permissions.
 * The rules enforce these roles at the data level, ensuring that only authorized users can read, write, or delete data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the 'role' field being critical for authorization.
 * - /policies/{policyId}: Stores insurance policies. Access is role-based.
 * - /claims/{claimId}: Stores insurance claims. Access is role-based, with subcollections for related data.
 * - /claims/{claimId}/documents/{documentId}: Stores documents associated with a specific claim.
 * - /claims/{claimId}/tasks/{taskId}: Stores tasks associated with a specific claim.
 *
 * Key Security Decisions:
 * - Strict RBAC: All data access is controlled by user roles.
 * - No User Listing: Listing all users is disallowed for non-admin roles.
 * - Subcollection Security: Access to subcollections is determined by the parent document's permissions and the user's role.
 * - Role enforcement: User 'role' is read from the /users/{userId} document and roles are immutable
 *
 * Denormalization for Authorization:
 * The 'role' field is stored directly in the user's profile document (/users/{userId}) to enable efficient role-based access control.
 * This avoids costly and complex queries to separate role collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Gets the role of the current user from their UserProfile document.
     * @return {string} The user's role, or an empty string if not found.
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    /**
     * @description Checks if the user has the 'admin' role.
     * @return {bool} True if the user has the 'admin' role, false otherwise.
     */
    function isAdmin() {
      return getUserRole() == 'admin';
    }

    /**
     * @description Checks if the user is the owner of a document.
     * @param {object} docResource The resource object of the document.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(docResource) {
      return isSignedIn() && request.auth.uid == docResource.data.owner;
    }
    
    /**
     * @description Checks if the user is a member of a document's sharedWith list.
     * @param {object} docResource The resource object of the document.
     * @return {bool} True if the user is a member, false otherwise.
     */
    function isSharedMember(docResource) {
      return isSignedIn() && request.auth.uid in docResource.data.sharedWith.map(s => s.uid);
    }

    /**
     * @description Checks if a user has a specific role on a document.
     * @param {object} docResource The resource object of the document.
     * @param {string} role The role to check for ('editor', 'viewer').
     * @return {bool} True if the user has the specified role, false otherwise.
     */
    function hasRole(docResource, role) {
      let userShare = docResource.data.sharedWith.filter(s => s.uid == request.auth.uid);
      return userShare.size() > 0 && userShare[0].role == role;
    }

    /**
     * @description Checks if a user is an editor of a document (owner or has 'editor' role).
     * @param {object} docResource The resource object of the document.
     * @return {bool} True if the user is an editor, false otherwise.
     */
    function isEditor(docResource) {
        return isOwner(docResource) || hasRole(docResource, 'editor');
    }

    /**
     * @description Checks if a user can view a document (owner, editor, or viewer).
     * @param {object} docResource The resource object of the document.
     * @return {bool} True if the user can view, false otherwise.
     */
    function isViewer(docResource) {
       return isOwner(docResource) || hasRole(docResource, 'editor') || hasRole(docResource, 'viewer');
    }

    /**
     * @description Rules for user profiles. Only admins can list/delete, owners can read/create,
     *              and admins or owners can update (but not change role).
     */
    match /users/{userId} {
      allow get: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (request.auth.uid == userId || isAdmin()) && request.resource.data.role == resource.data.role;
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for documents. Access is based on ownership and sharing roles.
     * @path /docs/{docId}
     */
    match /docs/{docId} {
      allow read: if isViewer(get(/databases/$(database)/documents/docs/$(docId)));
      allow create: if isSignedIn() && request.resource.data.owner == request.auth.uid;
      allow update: if isEditor(get(/databases/$(database)/documents/docs/$(docId)));
      allow delete: if isOwner(get(/databases/$(database)/documents/docs/$(docId)));

      /**
       * @description Rules for comments within a document.
       * @path /docs/{docId}/comments/{commentId}
       */
      match /comments/{commentId} {
        allow read: if isViewer(get(/databases/$(database)/documents/docs/$(docId)));
        allow create: if isSignedIn() && isViewer(get(/databases/$(database)/documents/docs/$(docId)));
        allow update, delete: if isOwner(resource) || isOwner(get(/databases/$(database)/documents/docs/$(docId)));
      }
    }

    /**
     * @description Rules for campaigns. Only admins and content managers have access.
     */
    match /campaigns/{campaignId} {
      allow read, write: if isAdmin() || getUserRole() == 'contentManager';
    }

    /**
     * @description Rules for game operations. Admin, Risk Analysts have access.
     */
    match /game_operations/{operationId} {
       allow read, write: if isAdmin() || getUserRole() == 'riskAnalyst';
    }

    /**
     * @description Rules for tasks. Users can only access their own tasks.
     *              (This is a simplification; a real app might share tasks).
     */
    match /tasks/{taskId} {
      allow read, write: if isSignedIn() && resource.data.assignedTo.hasAny([request.auth.uid]);
    }
  }
}

    