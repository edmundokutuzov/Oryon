
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar (opcional, mas limpa)
    function isAdmin() {
      // Lê a Custom Claim do token, não da base de dados!
      // Isto é instantâneo e funciona para operações de 'list'.
      return request.auth.token.admin == true;
    }

    function isDocViewer(docId) {
      return request.auth != null &&
        (get(/databases/$(database)/documents/docs/$(docId)).data.owner == request.auth.uid
         || request.auth.uid in get(/databases/$(database)/documents/docs/$(docId)).data.members);
    }

    function isDocOwner(docId) {
      return request.auth != null && get(/databases/$(database)/documents/docs/$(docId)).data.owner == request.auth.uid;
    }

    function isDocEditor(docId) {
      return isDocViewer(docId) && ( true ); // Placeholder, a lógica de role de edição estaria aqui
    }

    // Regra para a coleção de documentos
    match /docs/{docId} {
      
      // Permite ler (get) ou listar (list) a coleção
      // se o utilizador for admin OU se a consulta filtrar por 'members'.
      allow read: if request.auth != null && (isAdmin() || (request.query != null && request.query.where[0] == ['members', 'array-contains', request.auth.uid]));
      
      // Permite criar, atualizar ou apagar
      // apenas se o utilizador for um administrador.
      allow write: if request.auth != null && isAdmin();

      // Regras mais granulares para não-admins
      allow create: if request.auth != null;
      allow update: if isDocEditor(docId);
      allow delete: if isDocOwner(docId);
    }
    
    // As suas outras regras permanecem aqui...
    match /users/{userId} {
      allow read: if request.auth != null && (isAdmin() || request.auth.uid == userId);
      allow list: if isAdmin();
      allow create: if request.auth.uid == userId;
      allow update: if request.auth != null && (isAdmin() || request.auth.uid == userId);
      allow delete: if isAdmin();
    }
  }
}
